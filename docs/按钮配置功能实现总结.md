# 低代码平台按钮配置功能实现总结

## 已完成的工作

### 后端实现

#### 1. 实体类 (LowButtonConfig.java)
- ✅ 创建了按钮配置实体类
- ✅ 支持所有数据库字段映射
- ✅ 使用 @TableLogic 实现逻辑删除
- ✅ Boolean 类型字段正确映射 (is_plain -> plain)

#### 2. Mapper 接口 (LowButtonConfigMapper.java)
- ✅ 继承 BaseMapper<LowButtonConfig>
- ✅ 添加 @Mapper 注解

#### 3. Service 层
- ✅ ILowButtonConfigService 接口
- ✅ LowButtonConfigServiceImpl 实现类
- ✅ 核心方法：
  - getButtonList() - 分页查询
  - getButtonsByPageId() - 按页面查询
  - getButtonsByFormId() - 按表单查询
  - getButtonsByTableId() - 按表格查询
  - createButtonConfig() - 创建按钮
  - updateButtonConfig() - 更新按钮
  - deleteButtonConfig() - 删除按钮
  - batchSaveButtons() - 批量保存

#### 4. Controller 层 (ButtonConfigController.java)
- ✅ RESTful API 接口
- ✅ Swagger 文档注解
- ✅ 完整的 CRUD 操作

### 前端实现

#### 1. API 接口 (button.ts)
- ✅ TypeScript 接口定义 (ButtonConfig)
- ✅ API 方法封装：
  - getButtonList()
  - getButtonsByPageId()
  - getButtonsByFormId()
  - getButtonsByTableId()
  - createButton()
  - batchSaveButtons()
  - updateButton()
  - deleteButton()

#### 2. 按钮渲染组件 (ButtonRenderer.vue)
- ✅ 根据 ButtonConfig 渲染按钮
- ✅ 权限检查功能
- ✅ 显示条件表达式求值
- ✅ 点击事件触发

#### 3. 事件处理工具 (buttonActionHandler.ts)
- ✅ ButtonActionHandler 类
- ✅ 支持的动作类型：
  - dialog - 打开弹窗
  - drawer - 打开抽屉
  - route - 路由跳转
  - api - API请求
  - link - 打开链接
  - custom - 自定义代码
  - confirm - 确认框
- ✅ 模板字符串求值 ({{row.id}})
- ✅ 上下文变量支持 (row, form, selection)

#### 4. 表单设计器集成 (FormDesigner.vue)
- ✅ 添加"按钮配置"标签页
- ✅ 按钮列表展示
- ✅ 按钮添加、删除、排序
- ✅ 按钮属性配置表单
- ✅ 动作类型动态配置
- ✅ 样式美化

#### 5. 表格设计器集成 (TableDesigner.vue)
- ✅ 添加"按钮配置"标签页
- ✅ 工具栏按钮配置
- ✅ 操作列按钮配置
- ✅ 折叠面板展示
- ✅ 按钮预览功能
- ✅ 样式美化

## 功能特性

### 按钮位置支持
- toolbar - 表格工具栏
- row - 表格操作列
- form - 表单内按钮
- footer - 表单底部按钮
- dialog - 弹窗内按钮

### 按钮样式配置
- 按钮类型：primary/success/warning/danger/info/default
- 按钮尺寸：large/default/small
- 图标支持
- 朴素按钮
- 圆角按钮
- 圆形按钮
- 加载状态
- 禁用状态

### 动作类型配置

#### 1. Dialog（打开表单弹窗）
```json
{
  "formId": 1,
  "title": "新增用户",
  "width": "600px",
  "mode": "add|edit",
  "dataUrl": "/api/user/detail",
  "submitUrl": "/api/user/save",
  "successAction": {
    "type": "close|refresh",
    "message": "保存成功"
  }
}
```

#### 2. Drawer（打开抽屉）
```json
{
  "formId": 1,
  "title": "用户详情",
  "size": "medium|small|large",
  "mode": "add|edit"
}
```

#### 3. Route（路由跳转）
```json
{
  "path": "/system/user",
  "openType": "push|replace",
  "query": { "id": "{{row.id}}" }
}
```

#### 4. API（API请求）
```json
{
  "url": "/api/user/delete",
  "method": "POST",
  "params": {
    "fromRow": true,
    "custom": { "status": 0 }
  },
  "successAction": {
    "type": "refresh",
    "message": "删除成功"
  }
}
```

#### 5. Confirm（确认框）
```json
{
  "title": "确认删除",
  "message": "确定要删除吗？",
  "type": "warning",
  "action": { /* 其他 action_type 配置 */ }
}
```

#### 6. Custom（自定义代码）
```javascript
// 可以使用 row, form, selection 等上下文变量
console.log('当前行:', row)
ElMessage.success('自定义操作执行成功')
```

### 权限控制
- perms 字段存储权限标识（如 "user:add"）
- 按钮渲染前检查用户权限
- 与现有权限系统集成（需要完善）

### 显示条件
- 支持 JavaScript 表达式（如 "row.status === 1"）
- 上下文变量：row, form, selection
- 使用 Function 构造函数安全求值

## 数据库表结构

```sql
CREATE TABLE IF NOT EXISTS low_button_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '按钮ID',
    button_name VARCHAR(100) COMMENT '按钮名称',
    button_code VARCHAR(100) COMMENT '按钮编码',
    page_id BIGINT COMMENT '所属页面ID',
    position VARCHAR(50) COMMENT '位置(toolbar/row/form/dialog)',
    button_type VARCHAR(50) DEFAULT 'default' COMMENT '按钮类型',
    button_size VARCHAR(20) DEFAULT 'default' COMMENT '按钮尺寸',
    icon VARCHAR(100) COMMENT '图标',
    is_plain TINYINT DEFAULT 0 COMMENT '是否朴素按钮',
    is_round TINYINT DEFAULT 0 COMMENT '是否圆角按钮',
    is_circle TINYINT DEFAULT 0 COMMENT '是否圆形按钮',
    is_loading TINYINT DEFAULT 0 COMMENT '是否加载中',
    is_disabled TINYINT DEFAULT 0 COMMENT '是否禁用',
    action_type VARCHAR(50) COMMENT '动作类型',
    action_config TEXT COMMENT '动作配置JSON',
    confirm_config TEXT COMMENT '确认框配置JSON',
    perms VARCHAR(100) COMMENT '权限标识',
    sort_order INT DEFAULT 0 COMMENT '排序',
    is_visible TINYINT DEFAULT 1 COMMENT '是否显示',
    show_condition TEXT COMMENT '显示条件表达式',
    deleted TINYINT DEFAULT 0 COMMENT '是否删除',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_page_id (page_id),
    INDEX idx_button_code (button_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='按钮配置表';
```

## 使用示例

### 1. 在表单设计器中配置按钮

1. 打开表单设计器
2. 切换到"按钮配置"标签页
3. 点击"添加按钮"
4. 配置按钮属性：
   - 按钮名称：提交
   - 按钮编码：submit
   - 按钮位置：footer
   - 按钮类型：primary
   - 动作类型：api
   - 动作配置：
     ```json
     {
       "url": "/api/form/submit",
       "method": "POST",
       "successAction": {
         "type": "close",
         "message": "提交成功"
       }
     }
     ```

### 2. 在表格设计器中配置按钮

#### 工具栏按钮
1. 打开表格设计器
2. 切换到"按钮配置"标签页
3. 展开"工具栏按钮"
4. 点击"添加"按钮
5. 配置按钮属性：
   - 按钮名称：新增用户
   - 按钮编码：add_user
   - 动作类型：dialog
   - 动作配置：
     ```json
     {
       "formId": 1,
       "title": "新增用户",
       "width": "600px",
       "mode": "add"
     }
     ```

#### 操作列按钮
1. 展开"操作列按钮"
2. 点击"添加"按钮
3. 配置按钮属性：
   - 按钮名称：编辑
   - 按钮编码：edit
   - 动作类型：dialog
   - 动作配置：
     ```json
     {
       "formId": 1,
       "title": "编辑用户",
       "width": "600px",
       "mode": "edit",
       "dataUrl": "/api/user/detail"
     }
     ```

## 下一步工作

### 后端完善
1. ✅ 基础 CRUD 已完成
2. ⏳ 在保存表单/表格时同时保存按钮配置
3. ⏳ 在查询表单/表格时同时返回按钮配置

### 前端完善
1. ✅ 设计器集成已完成
2. ⏳ 在运行时页面渲染按钮
3. ⏳ 实现弹窗、抽屉等动作的具体逻辑
4. ⏳ 集成权限系统

### 测试验证
1. ⏳ 后端 API 测试
2. ⏳ 前端设计器测试
3. ⏳ 按钮渲染测试
4. ⏳ 动作执行测试

## 文件清单

### 后端文件
- backend/src/main/java/com/lowcode/entity/LowButtonConfig.java
- backend/src/main/java/com/lowcode/mapper/LowButtonConfigMapper.java
- backend/src/main/java/com/lowcode/service/ILowButtonConfigService.java
- backend/src/main/java/com/lowcode/service/impl/LowButtonConfigServiceImpl.java
- backend/src/main/java/com/lowcode/controller/ButtonConfigController.java

### 前端文件
- frontend/src/api/button.ts
- frontend/src/components/ButtonRenderer.vue
- frontend/src/utils/buttonActionHandler.ts
- frontend/src/views/lowcode/FormDesigner.vue (已修改)
- frontend/src/views/lowcode/TableDesigner.vue (已修改)

## API 端点

- GET `/api/button/list` - 分页查询按钮
- GET `/api/button/page/{pageId}` - 按页面查询
- GET `/api/button/form/{formId}` - 按表单查询
- GET `/api/button/table/{tableId}` - 按表格查询
- POST `/api/button` - 创建按钮
- POST `/api/button/batch/{pageId}` - 批量保存
- PUT `/api/button/{id}` - 更新按钮
- DELETE `/api/button/{id}` - 删除按钮
